---
title: "Running CAFE5"
output: html_document
date: "2024-04-02"
---

```{r setup, include=FALSE, echo=F}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(treeio)
library(ggtree)
library(stringr)
library(tidyverse)
```

We are going to run CAFE5 on Saga. CAFE5 is already installed on the common workshop project. If you want to install it for your own, please following the instruction at https://github.com/hahnlab/CAFE5.git


### Prepare input files 

CAFE5 needs as input an ultrametric dated species tree

```{r, echo=F}
speciesTree <- read.tree("/mnt/project/ELIXIR/EBP_workshop_2024/orthofinder/Results_Mar18/Species_Tree/SpeciesTree_rooted_node_labels.ultrametric.tree")
ggtree(speciesTree) + geom_tiplab() + hexpand(.1) 
```

and a table of gene count for each gene family.

```
Desc	Family ID	AspNid.pep	ConCor.proteins	SacCer.proteins	ggMorZona1.proteins	ggMucLanc1.proteins
(null)	N0.HOG0000000	1	0	2	2	4 ...
(null)	N0.HOG0000001	1	1	0	0	0 ...
(null)	N0.HOG0000002	0	1	0	0	0 ...
(null)	N0.HOG0000003	1	3	1	2	5 ...
(null)	N0.HOG0000004	0	0	2	0	0 ...
(null)	N0.HOG0000005	0	0	0	0	0 ...
(null)	N0.HOG0000006	0	0	0	0	1 ...
 ...
```
where the first column is the name of the family (if there's any), then the family ID, then the gene
count for each species.

Let first make a folder `cafe` in your home directory, and copy the necessary files from orthofinder results that
we need to generate the input fo `cafe`

```{bash, eval=F}
cd ~
mkdir cafe
cd cafe
cp /cluster/projects/nn9984k/data/orthofinder/Species_Tree/SpeciesTree_rooted_node_labels.txt mucoromycota.nwk
cp /cluster/projects/nn9984k/data/orthofinder/Phylogenetic_Hierarchical_Orthogroups/N0.tsv ./
```

Just want to shorten the species name in the tree by getting rid of `.proteins` and `.pep` at the end.

```{bash, eval=F}
sed -r -i "s#[.]p([^:]+)##g" mucoromycota.nwk 
```

### Dating the species tree

The species tree provided by `orthofinder` is not an ultrametric dated tree. There're several tools that can date a phylogenetic tree using different models. Here, to make it simple, and because we used `orthofinder` before, we will also its tools `make_ultrametric.py` 
to make the tree ultrametric. For this, we just need to specify the age of the root. We are not 
sure about the root age in this case, but based on some literature we guess it's around 850 millions years ago.
Note that this number is not just justified, we just take it's for demonstrating here. 

```{bash, eval = F}
python3 /cluster/projects/nn9984k/miniforge3/envs/orthofinder/bin/make_ultrametric.py -r 850 mucoromycota.nwk
```

That will generate a dated tree `mucoromycota.nwk.ultrametric.tre` inside the `cafe` folder.

### Generating the gene count table

For the gene count table, we need to count the number of genes in each column (species) for each row (gene family) in the
`N0.tsv` file . This can be done with, for example, an R script as follow. 


```{r,eval=F}
library(tidyverse)
library(stringr)
N0 <- read_tsv("N0.tsv")
colnames(N0) <- gsub("[.].+","",colnames(N0)) #remove .proteins and .pep and the end of the species name
N0_counts <- lapply(colnames(N0)[4:ncol(N0)], function(species){
  str_count(N0[[species]],",")+1
})
N0_counts <- bind_cols(N0_counts)
N0_counts[is.na(N0_counts)] <- 0
colnames(N0_counts) <- colnames(N0)[4:ncol(N0)]
N0_counts$Desc <- "(null)"
N0_counts$`Family ID` <- N0$HOG  
N0_counts <- select(N0_counts,Desc,`Family ID`, everything())
write_tsv(N0_counts,"mucoromycota_gene_families.txt")
```

We put a copy of this scrip here: `/cluster/projects/nn9984k/scripts/cafe/generate_gene_family_size.R`, so you can run it:

```{bash, eval=F}
module load R/4.3.2-gfbf-2023a
Rscript /cluster/projects/nn9984k/scripts/cafe/generate_gene_family_size.R 
```

### Running CAFE5

You should now have the 2 files `mucoromycota_gene_families.txt` and `mucoromycota.nwk.ultrametric.tre` in the folder `cafe`. If not, you can copy them from `/cluster/projects/nn9984k/data/cafe`.

Activate cafe environment to run cafe

```{bash, eval = F}
eval "$(/cluster/projects/nn9984k/miniforge3/bin/conda shell.bash hook)"
mamba activate cafe
```

You can have a look with all available options by typing `cafe5 -h`. We will run it with default setting.

We will run it with the default settings.

```{bash, eval=F}
cafe5 -i mucoromycota_gene_families.txt -t mucoromycota.nwk.ultrametric.tre -o cafe_results
```

Please don't run the command from the terminal of the login node. Instead of that, put the commands
into a `slurm` script file and submit it to the computing nodes. For example, we have a script here
`/cluster/projects/nn9984k/scripts/cafe/run_cafe.sh`, you can copy it and submit your job.

```{bash, eval=F}
cp /cluster/projects/nn9984k/scripts/cafe/run_cafe.sh ./
sbatch run_cafe.sh
```

Running CAFE5 on our whole fungi dataset would take a couple of hours. If everything goes well, you would have the results this evening and we can look at the results tomorrow morning.


